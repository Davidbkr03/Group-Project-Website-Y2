@page "/component"
@using Azure
@using Azure.AI.OpenAI
@using OpenAI_API
@using System.Net.Http
@using System.Text.Json
@using System.Text
@rendermode InteractiveServer

<div class="component">
    <h3>Speak to AI</h3>
    <input type="text" @bind="@userInput" />
    <button class="btn btn-primary" @onclick="AIResponseTest">Send</button>
    <button @onclick="ClosePanel">Close</button>
    <h4>AI Response: </h4>
    <p>@aiResponse</p>
</div>


@code {
    private string userInput = "";
    private string aiResponse = "";

    [Parameter] public EventCallback onClose { get; set; }

    private async Task ClosePanel()
    {
        await onClose.InvokeAsync();
    }
    

    private async Task AIResponseTest()
    {
        var client = new HttpClient();
        string systemContent = File.ReadAllText("input.txt");
        // Create the JSON object for the request body
        var requestBody = new
        {
            messages = new[]
            {
        new { role = "system", content = systemContent },
        new { role = "user", content = userInput }
    },
            temperature = 0.4,
            max_tokens = 1,
            stream = false
        };
        // Serialize the object to JSON
        var requestContent = new StringContent(JsonSerializer.Serialize(requestBody), Encoding.UTF8, "application/json");
        // Send the POST request to the Copilot endpoint
        HttpResponseMessage response = await client.PostAsync("http://localhost:1234/v1/chat/completions", requestContent);
        // Get the response content
        HttpContent responseContent = response.Content;
        string responseBody = await responseContent.ReadAsStringAsync();
        // Deserialize the response content to a JSON object
        var responseObject = JsonSerializer.Deserialize<JsonElement>(responseBody);
        // Extract the "content" value from the response
        string aiResponseContent = responseObject.GetProperty("choices")[0].GetProperty("message").GetProperty("content").GetString();
        // Assign the response content to the aiResponse variable
        aiResponse = aiResponseContent;


    }
}
